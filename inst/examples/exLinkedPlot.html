<html>
  <head>
<!--
    <script type="text/javascript" src="http://github.com/DmitryBaranovskiy/raphael/raw/master/raphael.js"> </script>
-->    
<script type="text/javascript" src="../javascript/raphael.js"> </script>

<script type="text/javascript" src="../javascript/Rhelpers.js"> </script>


    <script type="text/R">
      library(RFirefox)
      thing = raphaelDev("raphcanvas")
      trace(JS_RemoveRoot)
      plot(mtcars$hp, mtcars$mpg, xlab = "HP", ylab="MPG", main = "MtCars Hp vs Mpg", cex=3)
      
      thing2 = raphaelDev("raphcanvas2")
      plot(mtcars$wt, mtcars$qsec, xlab = "WT", ylab ="QSEC", main = "MtCars Wt vs Qsec", cex=3)
      pts = thing$getPoints()
      pts2 = thing2$getPoints()
      print(paste("len1: ", length(pts), "len2: ", length(pts2)))
      makeJSFun = function(name, i)
      {
        script = paste("function() { callRFunction('", name, "',", i, ");}", sep="")
        print(script)
        toret = jsVal()
        JS_EvaluateScript(ScriptCon, JS_GetGlobalObject(ScriptCon, returnInputs=FALSE), script, nchar(script), paste("making fun"), 1, toret)
        JS_AddRoot(ScriptCon, toret)
        toret
      }
      funs1 = sapply(1:length(pts), function(i) makeJSFun("colorIt", i))
      funs2 = sapply(1:length(pts), function(i) makeJSFun("unColorIt", i))
      
      addHandlers = function(pts)
      {
      sapply(1:length(pts), function(i)
      {
        
        pt = pts[[i]]
        call_JS_Method(ScriptCon, pt, "hover", list(funs1[[i]], funs2[[i]] ), addRoot= FALSE)
      } )
      if(FALSE)
{
      sapply(1:length(pts),
        function(x, pts, glob)
        {

          glob = JS_GetGlobalObject(ScriptCon, returnInputs = FALSE)
          #JS_AddRoot(ScriptCon, glob) 
          
          node = get_JS_Property(ScriptCon, pts[[x]], "node" )
          #already addrooted.
          #print(node)
                  
          args = list("colorIt", node, "mouseover", x) 
          call_JS_Method(ScriptCon, glob, "addREventHandler", args, addRoot = FALSE)
          args[[1]] = "unColorIt"
          args[[3]] = "mouseout"
          call_JS_Method(ScriptCon, glob, "addREventHandler", args, addRoot = FALSE)
          
          JS_RemoveRoot(ScriptCon, node)
          JS_RemoveRoot(ScriptCon, glob)
         }, pts = pts, glob = glob )
}
      return(TRUE)
      }
      addHandlers(pts)
      addHandlers(pts2)
      tmpCon = ScriptCon
      colorIt = function(i)
      {
        #XXX alert call below works. something about the actual call to attr on the points is causing the segfault.
        #call_JS_Method(tmpCon, pts[[i]], "attr", c("fill", "#ff0000"), addRoot = FALSE )
        
        #call_JS_Method(tmpCon, pts2[[i]], "attr", list("fill", "#ff0000"), addRoot = FALSE)
        call_JS_Method(ScriptCon, JS_GetGlobalObject(ScriptCon, returnInputs=FALSE), "alert", paste("Hi from R:", i), addRoot=FALSE)
      }

      unColorIt = function(i)
      {
        #call_JS_Method(tmpCon, pts[[i]], "attr", c("fill", "#ffffff"), addRoot = FALSE)
        
        #call_JS_Method(tmpCon, pts2[[i]], "attr", c("fill", "#ffffff"), addRoot = FALSE)
        
      }
      colorIt(5)
    </script>
  </head>
  <body>
    <div id="test1"> </div>
    <div id="test2"> </div>
    <div id="test3"> </div>
    <div id="test4"> </div>
    <div>
      <div id="raphcanvas" height="300" width="200" style="float:left" />
      <div id="raphcanvas2" height="300" width="200" style="float:left" />
      </div>
  </body>
</html>
